<?php

/**
 * @file
 * dss_qlik.module
 */

define('DSS_QLIK_PAGE', 'resources/ndis-provider-register/search');
define('DSS_QLIK_DIV_ID', 'dssqlikobject');
define('DSS_QLIK_OBJECT_ID', '3e864bb9-8c49-493a-ab3f-4e29cb204e2e');

/**
 * Implements hook_menu()
 */
function dss_qlik_menu() {
  return [
    /*'resources/ndis-provider-register' => [
      'title' => 'NDIS Provider Register',
      'page callback' => 'dss_qlik_page_controller',
      'access arguments' => [
        'access content'
      ],
      'file' => 'includes/dss_qlik.controller.inc',
      'type' => MENU_CALLBACK
    ],*/
    'resources/ndis-provider-register/search' => [
      'title' => 'Search results',
      'page callback' => 'dss_qlik_search_controller',
      'access arguments' => [
        'access content'
      ],
      'file' => 'includes/dss_qlik.controller.inc',
      'type' => MENU_CALLBACK
    ]
  ];
}

/**
 * Implements hook_theme()
 */
function dss_qlik_theme() {
  return [
    'dss_qlik_app' => [
      'variables' => [
        'div_id' => NULL,
        'object_id' => NULL,
        'config' => []
      ]
    ]
  ];
}

/**
 * Theme declaration for QLIK Application.
 */
function theme_dss_qlik_app($variables) {
  $config = $variables['config'];
  $div_id = $variables['div_id'];
  $object_id = $variables['object_id'];

  $output = [
    // @todo, move announcer to theme function.
    '#prefix' => '<div id="aria-live-announcer" aria-live="polite" aria-atomic=”true”></div>',
    '#markup' => '<div id="' . $div_id . '"></div>',
    '#attached' => [
      'js' => [
        [
          'data' => [
            'QlikConfig' => [
              'config' => $config,
              'div_id' => $div_id,
              'object_id' => $object_id
            ]
          ],
          'type' => 'setting'
        ],
        [
          'data' => drupal_get_path('module', 'dss_qlik') . '/js/dss_qlik_entrypoint.js',
          'group' => JS_THEME,
          'type' => 'file'
        ]
      ],
      'library' => [
        ['dss_qlik', 'QlikSense'],
        ['dss_qlik', 'QlikApp']
      ]
    ]
  ];

  return drupal_render($output);
}

/**
 * Implements hook_library()
 */
function dss_qlik_library() {
  return [
    'QlikSense' => [
      'title' => 'QLIK Sense',
      'website' => 'https://www.qlik.com/us',
      'version' => '5.7.*',
      'js' => [
        'https://qap.dss.gov.au/resources/assets/external/requirejs/require.js' => [
          'type' => 'external',
          'group' => JS_LIBRARY
        ]
      ],
      'css' => [
        /*'https://qap.dss.gov.au/resources/autogenerated/qlik-styles.css' => [
          'type' => 'external',
          'group' => CSS_THEME
        ],
        'https://qap.dss.gov.au/resources/assets/client/client.css' => [
          'type' => 'external',
          'group' => CSS_THEME
        ]*/
      ]
    ],
    'QlikApp' => [
      'title' => 'QLIK App',
      'website' => 'https://www.ndiscommission.gov.au',
      'version' => '0.1',
      'js' => [
        drupal_get_path('module', 'dss_qlik') . '/QlikApp/dist/qlik_search_app.js' => [
          'type' => 'file',
          'scope' => 'footer'
        ]
      ],
      'css' => [
        drupal_get_path('module', 'dss_qlik') . '/css/qlik_search_app.css' => [
          'type' => 'file',
          'group' => CSS_THEME
        ]
      ],
      'dependencies' => [
        ['dss_qlik', 'QlikSense']
      ]
    ],
    'QlikAppStable' => [
      'title' => 'QLIK App',
      'website' => 'https://www.ndiscommission.gov.au',
      'version' => '0.1',
      'js' => [
        drupal_get_path('module', 'dss_qlik') . '/QlikApp/dist/qlik_search_app.stable.js' => [
          'type' => 'file',
          'scope' => 'footer'
        ]
      ],
      'css' => [
        drupal_get_path('module', 'dss_qlik') . '/css/qlik_search_app.css' => [
          'type' => 'file',
          'group' => CSS_THEME
        ]
      ],
      'dependencies' => [
        ['dss_qlik', 'QlikSense']
      ]
    ]
  ];
}
